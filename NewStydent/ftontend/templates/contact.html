{% extends "base.html" %}
{% load static %}
{% block title %}NeXus — Чат с ИИ-консультантом{% endblock %}

{% block extra_head %}>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <style>
    :root {
      --color-primary: #007AFF;
      --color-bg: #F5F5F7;
      --color-bg-secondary: #FFFFFF;
      --color-text: #1D1D1F;
      --color-text-secondary: #6E6E73;
      --color-border: #D2D2D7;
      --color-shadow: rgba(0, 0, 0, 0.08);
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Inter', sans-serif;
      background-color: var(--color-bg);
      color: var(--color-text);
      line-height: 1.5;
      overflow-wrap: anywhere;
    }
    button, a, input { transition: all 0.3s ease; }
        .contact-page-container {
      width: min(100%, 900px);
      margin-inline: auto;
      padding: clamp(1.5rem, 4vw, 2.5rem) clamp(1rem, 4vw, 3rem) clamp(2rem, 6vw, 4rem);
      min-height: calc(100vh - 3rem);
      display: flex;
      flex-direction: column;
    }
    @media (max-width: 640px) {
      .contact-page-container {
        padding: 1rem;
        min-height: 100vh;
      }
    }
    .contact-chat-wrapper {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }
    .card {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      border: 1px solid var(--color-border);
      border-radius: 18px;
      box-shadow: 0 4px 30px var(--color-shadow);
    }
    .contact-chat-card {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
      height: min(850px, calc(100vh - 8rem));
      overflow: hidden;
      width: 100%;
    }
    @media (min-width: 768px) {
      .contact-chat-card {
        margin-inline: auto;
        width: min(100%, 760px);
      }      
    }
    @media (max-width: 1024px) {
      .contact-chat-card {
        height: auto;
      }
    }
    #chat-container {
      min-height: 0;
      max-height: calc(100vh - 220px);
      overflow-y: auto;
      padding-right: 0.25rem;
      scroll-behavior: smooth;
      overscroll-behavior: contain;
    }
    #chat-container::-webkit-scrollbar {
      width: 8px;
    }
    #chat-container::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.05);
      border-radius: 8px;
    }
    #chat-container::-webkit-scrollbar-thumb {
      background: var(--color-primary);
      border-radius: 8px;
    }   
    button:hover, a:hover { transform: translateY(-1px); }
    .message {
      max-width: 75%;
      padding: 0.75rem 1.25rem;
      border-radius: 1rem;
      margin-bottom: 1rem;
      font-size: 0.9rem;
      line-height: 1.5;
    }
    .animate-fade-in { animation: fade-in 0.3s ease forwards; }
    @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
    .user-message {
      align-self: flex-end;
      background: var(--color-primary);
      color: #fff;
      border-bottom-right-radius: 0.25rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    .bot-message {
      align-self: flex-start;
      background: var(--color-bg-secondary);
      border: 1px solid var(--color-border);
      color: var(--color-text);
      border-bottom-left-radius: 0.25rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    .message-image {
      max-width: 50%;
      padding: 0.25rem;
      border-radius: 0.75rem;
      margin-bottom: 1rem;
      background: var(--color-bg-secondary);
      border: 1px solid var(--color-border);
    }
    .message-image img { width: 100%; border-radius: 0.5rem; }
    .media-preview-item {
      position: relative;
      width: 80px;
      height: 80px;
      border-radius: 0.5rem;
      overflow: hidden;
      border: 1px solid var(--color-border);
    }
    .media-preview-item img { width: 100%; height: 100%; object-fit: cover; }
    .media-preview-item button {
      position: absolute;
      top: 0.25rem;
      right: 0.25rem;
      background: rgba(0, 0, 0, 0.5);
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    .media-preview-item button:hover { background: rgba(0, 0, 0, 0.7); }
    @keyframes slide-in { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .animate-slide-in { animation: slide-in 0.3s ease; }
    .test-option {
      background: var(--color-primary);
      color: white;
      border: none;
      border-radius: 0.75rem;
      padding: 0.75rem 1rem;
      margin: 0.25rem;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .test-option:hover { background: #0051CC; transform: translateY(-2px); }
    .test-question {
      background: var(--color-bg-secondary);
      border: 1px solid var(--color-border);
      border-radius: 1rem;
      padding: 1rem;
      margin-bottom: 1rem;
    }
    .university-button {
      background: var(--color-primary);
      color: white;
      border: none;
      border-radius: 0.75rem;
      padding: 0.5rem 1rem;
      margin: 0.25rem;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.8rem;
    }
    .university-button:hover { background: #0051CC; transform: translateY(-1px); }
    .profession-button {
      background: #28a745;
      color: white;
      border: none;
      border-radius: 0.75rem;
      padding: 0.5rem 1rem;
      margin: 0.25rem;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.8rem;
    }
    .profession-button:hover { background: #218838; transform: translateY(-1px); }
    .recommendation-button {
      background: #ff6b35;
      color: white;
      border: none;
      border-radius: 0.75rem;
      padding: 0.75rem 1.5rem;
      margin: 0.5rem;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 1rem;
      font-weight: bold;
    }
    .recommendation-button:hover { background: #e55a2b; transform: translateY(-2px); }
    .university-card {
      background: var(--color-bg-secondary);
      border: 1px solid var(--color-border);
      border-radius: 1rem;
      padding: 1rem;
      margin: 0.5rem 0;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    .university-link {
      display: inline-block;
      background: var(--color-primary);
      color: white;
      border: none;
      border-radius: 0.75rem;
      padding: 0.5rem 1rem;
      margin: 0.5rem 0;
      text-decoration: none;
      transition: all 0.3s ease;
    }
    .university-link:hover { background: #0051CC; transform: translateY(-1px); }
  </style>
{% endblock %}

{% block content %}
  <div class="contact-page-container">
    <div class="contact-chat-wrapper">
      <h1 class="text-3xl font-semibold tracking-tight mb-6 sm:mb-8">Чат с ИИ-консультантом по профориентации</h1>
      <div class="card flex flex-col contact-chat-card">
      <div id="chat-container" class="flex-1 p-4 space-y-3 bg-[var(--color-bg)] flex flex-col">
        <!-- Messages will be loaded here -->
      </div>
      <div class="p-4 border-t border-[var(--color-border)]">
        <div id="media-preview" class="hidden flex gap-2 mb-4 flex-wrap"></div>
        <form id="chat-form" class="flex gap-2" style="flex-wrap: wrap;">
          <input type="text" id="chat-input" placeholder="Задайте вопрос о профессиях, вузах или профориентации..." class="flex-grow min-w-[150px] border border-[var(--color-border)] rounded-xl px-4 py-2 focus:outline-none focus:ring-2 focus:ring-[var(--color-primary)]" />
          <label for="chat-file" class="cursor-pointer text-[var(--color-primary)] hover:underline flex items-center px-3 shrink-0" title="Прикрепить изображение">
            <i class="fas fa-paperclip"></i>
          </label>
          <input type="file" id="chat-file" accept="image/*" style="display:none" multiple />
          <button id="cancel-media" type="button" class="bg-red-500 text-white rounded-xl font-semibold px-4 py-2 shrink-0 min-w-[80px] hover:bg-red-600 shadow-sm hidden">Отмена</button>
          <button type="submit" class="bg-[var(--color-primary)] text-white rounded-xl font-semibold px-4 py-2 shrink-0 min-w-[80px] hover:bg-[#0051CC] shadow-sm">Отправить</button>
          <button type="button" id="clear-chat" class="bg-gray-500 text-white rounded-xl font-semibold px-4 py-2 shrink-0 min-w-[80px] hover:bg-gray-600 shadow-sm">Новый чат</button>
        </form>
      </div>
    </div>
   </div>
  </div>
{% endblock %}

{% block extra_scripts %}

  <script>
    document.addEventListener('DOMContentLoaded', () => {

      // Chat Functionality
      const chatForm = document.getElementById('chat-form');
      const chatInput = document.getElementById('chat-input');
      const chatContainer = document.getElementById('chat-container');
      const chatFileInput = document.getElementById('chat-file');
      const mediaPreview = document.getElementById('media-preview');
      const cancelMediaButton = document.getElementById('cancel-media');
      const clearChatButton = document.getElementById('clear-chat');

      const stopWords = ['и', 'в', 'на', 'по', 'ли', 'это', 'а', 'к', 'у', 'за', 'то', 'же', 'от', 'с', 'без'];
      
      // БАЗА ДАННЫХ УНИВЕРСИТЕТОВ КАЗАХСТАНА
      const universities = {
        "kaznu": {
          name: "Казахский национальный университет им. аль-Фараби (KazNU / Farabi)",
          military: "есть (военная подготовка, набор по конкурсу)",
          scores: "пороговые баллы ЕНТ варьируются по программам (от ~65 и выше)",
          budget: "есть бюджетные места, количество указано в таблицах пороговых баллов",
          directions: "гуманитарные науки, филология, социальные науки, естественные науки, математика, ИT, экономика, юриспруденция, педагогика",
          aliases: ["казну", "farabi", "аль-фараби", "казахский национальный университет"],
          url: "/universities/kaznu/",
          description: "Ведущий классический университет Казахстана с сильными научными школами и международными программами.",
          strengths: ["Фундаментальные науки", "Международные программы", "Научные исследования"],
          image: "https://upload.wikimedia.org/wikipedia/commons/a/a1/Al-Farabi_Kazakh_National_University_main_building.jpg"
        },
        "abai": {
          name: "Казахский национальный педагогический университет им. Абая (Abai University)",
          military: "есть (отбор на конкурсной основе)",
          scores: "для педагогических направлений часто выше (от ~70), для других от ~65",
          budget: "есть бюджетные места, публикуются по группам образовательных программ",
          directions: "педагогика, дошкольное и школьное образование, методики преподавания, физкультура, музыка, искусство",
          aliases: ["абай", "abai", "казахский педагогический", "кзнпу"],
          url: "/universities/kaznpu/",
          description: "Главный педагогический университет страны с богатой историей подготовки учителей и методистов.",
          strengths: ["Педагогическое образование", "Методики преподавания", "Психология"],
          image: "https://upload.wikimedia.org/wikipedia/commons/5/56/Akhmet_Baitursynuly_Street_13_Almaty_02.jpg"
        },
        "satbayev": {
          name: "Satbayev University (Сатбаев)",
          military: "есть (приём на кафедру проводится на конкурсной основе)",
          scores: "минимум для конкурса грантов от 65 баллов",
          budget: "есть бюджетные места по программам",
          directions: "инженерия, IT, математика, информационные системы, информационная безопасность, компьютерные науки",
          aliases: ["сатбаев", "satbayev", "сатпаев"],
          url: "/universities/satbayev/",
          description: "Инженерно-технический лидер региона с акцентом на цифровые технологии и партнерство с индустрией.",
          strengths: ["Инженерия", "IT технологии", "Технические науки"],
          image: "https://upload.wikimedia.org/wikipedia/commons/0/0f/Kazakh-British_Technical_University.jpg"
        },
        "kaznmu": {
          name: "Казахский национальный медицинский университет им. С.Д. Асфендиярова (KazNMU)",
          military: "есть (правила приёма на военную кафедру)",
          scores: "высокие баллы (часто >110 в зависимости от программы)",
          budget: "есть бюджетные места по специальностям",
          directions: "медицина (лечебное дело), педиатрия, стоматология, фармация, сестринское дело, общественное здоровье",
          aliases: ["казнму", "медицинский", "асфендияров"],
          url: "/universities/kaznmu/",
          description: "Крупнейший медицинский вуз Казахстана с современной клинической базой и симуляционными центрами.",
          strengths: ["Медицина", "Клиническая практика", "Фармация"],
          image: "https://upload.wikimedia.org/wikipedia/commons/4/4f/S.D._Asfendiyarov_Kazakh_National_Medical_University.jpg"
        },
        "abylai": {
          name: "Казахский университет международных отношений и мировых языков им. Абылай хана (KazUIR)",
          military: "информация опубликована на сайте (см. раздел «Абитуриентам»)",
          scores: "разные по программам, публикуются на сайте",
          budget: "есть бюджетные места, публикуются ежегодно",
          directions: "международные отношения, дипломатия, лингвистика, регионоведение, перевод, политология",
          aliases: ["абылай", "abylai", "казахский университет международных отношений"],
          url: "/universities/kazumo/",
          description: "Специализируется на международных отношениях, переводе и глобальной коммуникации.",
          strengths: ["Международные отношения", "Лингвистика", "Дипломатия"],
          image: "https://upload.wikimedia.org/wikipedia/commons/2/27/Ablai_Khan_University.jpg"
        },
        "kbtu": {
          name: "Казахстанско-Британский технический университет (KBTU)",
          military: "есть (набор на военную кафедру)",
          scores: "высокий конкурс (100+ или 110+ для популярных направлений)",
          budget: "есть бюджетные места по программам",
          directions: "инженерия, IT, менеджмент в технических сферах, химинжиниринг, материалы, электроника, финансы",
          aliases: ["кбту", "kbtu", "британский технический"],
          url: "#",
          description: "Технический вуз с британской системой образования и акцентом на практические навыки.",
          strengths: ["Техническое образование", "Международные стандарты", "Практическая подготовка"],
          image: "https://kbtu.edu.kz/images/2022/09/01/1.jpg"
        },
        "dku": {
          name: "Казахстанско-Немецкий университет (DKU)",
          military: "информация на официальном сайте",
          scores: "пороги зависят от группы образовательных программ",
          budget: "есть гранты и квоты (частный/международный вуз)",
          directions: "менеджмент, международное сотрудничество, инженерные программы с немецкой компонентой, языки, бизнес-образование",
          aliases: ["дку", "dku", "немецкий университет"],
          url: "/universities/german/",
          description: "Мост между Казахстаном и Европой с программами на немецком и английском языках.",
          strengths: ["Международные программы", "Немецкий язык", "Бизнес-образование"],
          image: "https://dku.kz/assets/files/000/000/378/original/DSC_3159.jpg"
        },
        "atu": {
          name: "Алматинский технологический университет (АТУ)",
          military: "есть (набор на военную подготовку)",
          scores: "пороги по прграммам (от ~45–65 и выше)",
          budget: "есть бюджетные места",
          directions: "пищевая промышленность, текстиль, технологии, инженерные специальности, IT, экономика, туризм и сервис",
          aliases: ["ату", "atu", "алматинский технологический"],
          url: "/universities/technological/",
          description: "Лидер в сфере пищевых технологий, дизайна и лёгкой промышленности.",
          strengths: ["Пищевые технологии", "Дизайн", "Легкая промышленность"],
          image: "https://tengrinews.kz/userdata/news/2017/news_326837/thumb_m/photo_219423.png"
        }
      };

      // РАСШИРЕННЫЙ FAQ ДЛЯ ПРОФОРИЕНТАЦИИ
      const faq = [
        {
          keywords: ['профессия', 'профессии', 'кем стать', 'выбор профессии', 'карьера', 'профориентация', 'будущая профессия', 'специальность', 'профессиональный выбор', 'кем работать', 'какую профессию выбрать', 'профессиональное самоопределение', 'выбрать профессию', 'определиться с профессией', 'будущая работа', 'карьерный путь', 'профессиональная деятельность'],
          answer: 'На платформе NeXus вы можете пройти профориентационные тесты, которые помогут определить подходящие профессии на основе ваших интересов, способностей и оценок. Мы анализируем ваши склонности и предлагаем профессии, которые будут вам интересны и востребованы на рынке труда.'
        },
        {
          keywords: ['тест', 'тесты', 'профтест', 'профориентационный', 'пройти тест', 'опрос', 'анкета', 'диагностика', 'тестирование', 'пройти опрос', 'пройти анкету', 'профориентационный тест', 'тест на профориентацию', 'тест на профессию', 'пройти диагностику', 'тестирование способностей', 'опросник', 'психологический тест'],
          answer: 'В разделе "Тесты" доступны различные профориентационные тесты. После прохождения вы получите персональные рекомендации по профессиям и направлениям обучения. Хотите пройти быстрый тест прямо сейчас? Напишите "пройти тест" или "начать тестирование".'
        },
        {
          keywords: ['пройти тест', 'начать тест', 'начать тестирование', 'пройти опрос', 'запустить тест', 'начать профтест', 'пройти профориентацию', 'начать профориентацию', 'хочу тест', 'можно тест', 'давай тест', 'протестируй меня', 'проведи тест', 'сделать тест', 'пройти проверку', 'тестируй'],
          answer: 'test' // Специальный маркер для запуска теста
        },
        {
          keywords: ['военная кафедра', 'военка', 'армия', 'военная подготовка', 'военное дело', 'военную', 'кафедра', 'военную подготовку', 'служба', 'отсрочка'],
          answer: 'military' // Специальный маркер для вопроса о военной кафедре
        },
        {
          keywords: ['баллы', 'проходной балл', 'ент', 'экзамен', 'результаты', 'минимальный балл', 'вступительные', 'баллы ент', 'средний балл', 'проходные баллы', 'баллы для поступления', 'минимальные баллы', 'требуемые баллы', 'результаты экзаменов', 'вступительные испытания', 'экзаменационные баллы', 'пороговый'],
          answer: 'scores' // Специальный маркер для вопроса о баллах
        },
        {
          keywords: ['бюджет', 'грант', 'стипендия', 'бюджетное', 'бесплатное', 'обучение', 'финансирование', 'стоимость', 'цена', 'бюджетное место', 'контракт', 'оплата обучения', 'стоимость обучения', 'бесплатное обучение', 'гранты на обучение', 'образовательные гранты', 'стипендии для студентов', 'финансовая помощь'],
          answer: 'budget' // Специальный маркер для вопроса о бюджете
        },
        {
          keywords: ['направления', 'специальности', 'факультеты', 'программы', 'образование', 'обучение', 'что изучать', 'какие направления', 'специальность', 'факультет', 'образовательная программа'],
          answer: 'directions'
        },
        {
          keywords: ['университет', 'университета', 'вузы', 'вуз', 'универ', 'университеты', 'университетов', 'колледж', 'институт', 'учебное заведение'],
          answer: 'university'
        },
        {
          keywords: ['спасибо', 'благодарю', 'благодарю вас', 'спасибо большое', 'благодарен', 'все понятно', 'понял', 'ясно', 'круто'],
          answer: 'Рад помочь! Если появятся ещё вопросы о профессиях или университетах — пишите.'
        },
        {
          keywords: ['привет', 'здравствуйте', 'добрый день', 'добрый вечер', 'доброе утро', 'хай', 'hello', 'hi'],
          answer: 'Здравствуйте! Чем могу помочь в выборе профессии или университета?'
        }
      ];

      const defaultReply = 'Не совсем понял ваш вопрос о профориентации или выборе вуза. Попробуйте переформулировать или напишите "Позвать консультанта" для связи со специалистом. Можете также рассказать о своих интересах - я помогу подобрать профессии!';

      // РАСШИРЕННЫЕ ДАННЫЕ ДЛЯ ПРОФОРИЕНТАЦИОННОГО ТЕСТА ДЛЯ ВЫПУСКНИКОВ
      const proforientationTest = [
        {
          question: "1. Ваша главная суперсила в командном проекте проявляется в том, что вы:",
          options: {
            analyst: "Хладнокровно анализирую проблему и составляю четкий план действий",
            innovator: "Придумываю нестандартные идеи, которых никто не ожидал",
            communicator: "Объединяю команду, нахожу компромиссы и распределяю роли",
            pragmatist: "Беру на себя самую сложную часть и довожу дело до результата"
          }
        },
        {
          question: "2. Что вызывает у вас наибольший страх при выборе будущего?",
          options: {
            analyst: "Ошибиться с выбором и потратить годы на невостребованную специальность",
            innovator: "Попасть в рутину и потерять возможность творческой реализации",
            communicator: "Оказаться в изоляции, без интересного окружения и команды",
            pragmatist: "Не увидеть реальных результатов своего труда и влияния на мир"
          }
        },
        {
          question: "3. Представьте, что через 10 лет вы достигли успеха. Что для вас означает эта 'вершина'?",
          options: {
            analyst: "Стать признанным экспертом, к мнению которого прислушиваются в профессиональной среде",
            innovator: "Создать что-то уникальное, что изменит представления людей",
            communicator: "Построить сильное сообщество или компанию с особыми ценностями",
            pragmatist: "Создать работающую систему, которая приносит реальную пользу"
          }
        },
        {
          question: "4. Вспомните момент, когда вы почувствовали настоящее удовлетворение от учебы. С чем он был связан?",
          options: {
            analyst: "'Я наконец-то разобрался в этой сложной теме и понял все взаимосвязи'",
            innovator: "'Мне удалось найти необычное решение, которое удивило всех'",
            communicator: "'Наша команда смогла достичь цели, которую казалось невозможно выполнить'",
            pragmatist: "'Я смог применить знания на практике и получил осязаемый результат'"
          }
        },
        {
          question: "5. Какой тип обратной реакции на вашу работу для вас наиболее ценен?",
          options: {
            analyst: "Конкретная оценка с аргументами: 'Здесь сильная сторона, а здесь можно улучшить...'",
            innovator: "Реакция на уникальность: 'Такого подхода я еще не видел, это свежо'",
            communicator: "Личностный отклик: 'Мне нравится твоя энергия и подход к делу'",
            pragmatist: "Оценка эффективности: 'Благодаря твоей работе мы продвинулись к цели'"
          }
        },
        {
          question: "6. Ваше отношение к правилам и традициям в образовании:",
          options: {
            analyst: "Они существуют для эффективности, но должны меняться, когда устаревают",
            innovator: "Часто задаюсь вопросом 'а что, если сделать иначе?' и пробую новые подходы",
            communicator: "Мне комфортно, когда все понятно и предсказуемо",
            pragmatist: "Воспринимаю как инструмент - соблюдаю, если это помогает достичь цели"
          }
        },
        {
          question: "7. Как вы восстанавливаете силы после интенсивной учебы?",
          options: {
            analyst: "В одиночестве: за книгами, играми, глубоким погружением в хобби",
            innovator: "Переключаясь на другой вид творческой деятельности",
            communicator: "В общении с друзьями, за совместными мероприятиями",
            pragmatist: "Через физическую активность: спорт, прогулки, практические занятия"
          }
        },
        {
          question: "8. Если бы вам гарантировали успех в любом случае, какую сферу деятельности вы бы выбрали?",
          options: {
            analyst: "Научные исследования или аналитику в перспективной области",
            innovator: "Создание собственного творческого проекта или стартапа",
            communicator: "Работу с людьми в сфере образования, психологии или управления",
            pragmatist: "Разработку технологий или систем, решающих реальные проблемы"
          }
        },
        {
          question: "9. Ваша самая частая 'внутренняя критика' во время учебы звучит так:",
          options: {
            analyst: "'Ты слишком медлительный, везде хочешь докопаться до идеального понимания'",
            innovator: "'Тебе не хватает системности, ты слишком импульсивен в решениях'",
            communicator: "'Ты слишком много берешь на себя, не умеешь распределять нагрузку'",
            pragmatist: "'Ты недостаточно рискуешь, слишком осторожничаешь в новых начинаниях'"
          }
        },
        {
          question: "10. Что для вас важнее в команде единомышленников?",
          options: {
            analyst: "Глубокие знания и экспертиза каждого в своей области",
            innovator: "Гибкость мышления и открытость к экспериментам",
            communicator: "Надежность и взаимопонимание между участниками",
            pragmatist: "Энтузиазм и стремление к достижению конкретных результатов"
          }
        },
        {
          question: "11. Когда вы принимаете сложное решение о будущем, вы опираетесь на:",
          options: {
            analyst: "Анализ данных, статистику, прогнозы востребованности профессий",
            innovator: "Внутреннее чутье и видение своего потенциала",
            communicator: "Мнение близких и примеры успешных людей вокруг",
            pragmatist: "Практический опыт и конкретные примеры реализации"
          }
        },
        {
          question: "12. Как вы относитесь к публичным выступлениям и защите своих идей?",
          options: {
            analyst: "Это стресс, но я готовлюсь основательно, чтобы аргументы были железобетонными",
            innovator: "Это моя стихия - я люблю делиться идеями и вести за собой аудиторию",
            communicator: "Мне комфортно, если тема действительно близка и я в ней разбираюсь",
            pragmatist: "Предпочитаю показать результат на деле, а не рассказывать о нем"
          }
        },
        {
          question: "13. Ваше отношение к конкурентной среде в учебе и будущей карьере:",
          options: {
            analyst: "Воспринимаю как неизбежность, которая мотивирует развиваться",
            innovator: "Вижу в ней возможность выделиться и показать свою уникальность",
            communicator: "Стараюсь превратить конкуренцию в сотрудничество",
            pragmatist: "Не боюсь конкуренции, если она справедливая и основана на реальных достижениях"
          }
        },
        {
          question: "14. Что для вас важнее в будущей профессии?",
          options: {
            analyst: "Стабильность и четкие перспективы карьерного роста",
            innovator: "Свобода творчества и возможность реализовывать смелые идеи",
            communicator: "Интересное окружение и возможность работать в команде",
            pragmatist: "Осязаемый результат и реальное влияние на мир"
          }
        },
        {
          question: "15. Какой из этих вариантов летней практики вас привлекает больше?",
          options: {
            analyst: "Исследовательская работа в лаборатории или аналитическом центре",
            innovator: "Участие в творческом проекте или стартапе",
            communicator: "Работа в молодежном лагере или социальном проекте",
            pragmatist: "Стажировка на производстве или в технологической компании"
          }
        },
        {
          question: "16. Ваша реакция на сложную задачу, которая кажется нерешаемой:",
          options: {
            analyst: "Разбиваю на части и методично ищу решение для каждой",
            innovator: "Пробую нестандартные подходы, которые другим в голову не приходят",
            communicator: "Обращаюсь за помощью к тем, кто может знать ответ",
            pragmatist: "Экспериментирую с разными методами, пока не найду рабочий"
          }
        },
        {
          question: "17. Что для вас означает 'быть успешным студентом'?",
          options: {
            analyst: "Глубоко понимать предмет и уметь применять знания в сложных ситуациях",
            innovator: "Находить оригинальные решения и создавать что-то новое",
            communicator: "Быть частью академического сообщества и помогать другим",
            pragmatist: "Освоить практические навыки, которые пригодятся в реальной работе"
          }
        },
        {
          question: "18. Как вы выбираете тему для проекта или исследования?",
          options: {
            analyst: "Ищу область, где есть нерешенные проблемы и возможности для глубокого анализа",
            innovator: "Выбираю то, что позволяет проявить креативность и создать нечто уникальное",
            communicator: "Ориентируюсь на темы, которые интересны моему окружению и могут принести пользу другим",
            pragmatist: "Выбираю практические задачи, результат которых можно увидеть и применить"
          }
        },
        {
          question: "19. Ваше отношение к междисциплинарным проектам:",
          options: {
            analyst: "Вижу в них возможность применить аналитические методы из разных областей",
            innovator: "Это шанс создать что-то принципиально новое на стыке дисциплин",
            communicator: "Нравится работать с людьми из разных сфер и объединять их подходы",
            pragmatist: "Ценю возможность решать комплексные проблемы, требующие разных навыков"
          }
        },
        {
          question: "20. Какой формат обучения вам ближе?",
          options: {
            analyst: "Лекции с глубоким погружением в теорию и последующим анализом",
            innovator: "Мастер-классы и воркшопы, где можно экспериментировать",
            communicator: "Групповые обсуждения и проектная работа в командах",
            pragmatist: "Лабораторные работы и практикумы с реальными кейсами"
          }
        },
        {
          question: "21. Что для вас самое сложное в подготовке к экзаменам?",
          options: {
            analyst: "Принять, что невозможно изучить все досконально, приходится выбирать главное",
            innovator: "Следовать стандартным шаблонам вместо поиска собственных решений",
            communicator: "Заниматься в одиночку без возможности обсудить материал с другими",
            pragmatist: "Учить теорию без понимания ее практического применения"
          }
        },
        {
          question: "22. Как вы относитесь к возможности учиться за границей?",
          options: {
            analyst: "Это шанс получить доступ к лучшим исследовательским ресурсам и методикам",
            innovator: "Возможность познакомиться с разными культурами и подходами к творчеству",
            communicator: "Отличный способ расширить круг общения и завести международные контакты",
            pragmatist: "Практический опыт жизни в другой системе и изучения передовых технологий"
          }
        },
        {
          question: "23. Ваша реакция на критику вашей работы:",
          options: {
            analyst: "Внимательно анализирую замечания и ищу рациональное зерно",
            innovator: "Рассматриваю как возможность увидеть свою работу под другим углом",
            communicator: "Стараюсь понять позицию критика и найти взаимопонимание",
            pragmatist: "Оцениваю практическую ценность замечаний для улучшения результата"
          }
        },
        {
          question: "24. Что для вас важнее в выборе вуза?",
          options: {
            analyst: "Глубина академической программы и квалификация преподавателей",
            innovator: "Свобода выбора курсов и возможность реализовывать собственные проекты",
            communicator: "Атмосфера в кампусе и активная студенческая жизнь",
            pragmatist: "Связи с индустрией и возможности для стажировок"
          }
        },
        {
          question: "25. Как вы представляете свой идеальный рабочий день через 5 лет?",
          options: {
            analyst: "Решение сложных задач в спокойной обстановке с доступом к данным и ресурсам",
            innovator: "Генерация идей и их воплощение в динамичной творческой среде",
            communicator: "Взаимодействие с коллегами и клиентами, решение организационных вопросов",
            pragmatist: "Создание работающих прототипов и тестирование их в реальных условиях"
          }
        },
        {
          question: "26. Ваше отношение к работе в больших корпорациях vs стартапах:",
          options: {
            analyst: "Предпочитаю структурированную среду с четкими процессами и ресурсами",
            innovator: "Больше привлекает гибкость и возможность быстро реализовывать идеи",
            communicator: "Ценю и то и другое - важно, чтобы была хорошая команда и атмосфера",
            pragmatist: "Выбираю то, где можно увидеть прямое влияние своей работы на результат"
          }
        },
        {
          question: "27. Как вы относитесь к необходимости постоянно учиться новому в профессии?",
          options: {
            analyst: "Это естественная часть развития - систематически осваиваю новые методы и технологии",
            innovator: "Обожаю этот процесс - новые знания дают пищу для творчества",
            communicator: "Нравится учиться в группе, обмениваться опытом с коллегами",
            pragmatist: "Ценю обучение, которое сразу можно применить на практике"
          }
        },
        {
          question: "28. Что для вас означает 'найти свое призвание'?",
          options: {
            analyst: "Обнаружить область, где мои аналитические способности приносят максимальную пользу",
            innovator: "Найти дело, которое позволяет полностью раскрыть творческий потенциал",
            communicator: "Заниматься тем, что помогает людям и создает значимые связи",
            pragmatist: "Делать то, что дает ощутимые результаты и реальные изменения"
          }
        },
        {
          question: "29. Как вы справляетесь с неудачами в учебе или проектах?",
          options: {
            analyst: "Анализирую причины и разрабатываю стратегию избежания подобных ошибок",
            innovator: "Рассматриваю как ценный опыт и ищу новые неожиданные пути",
            communicator: "Обсуждаю с другими, ищу поддержку и совместные решения",
            pragmatist: "Беру паузу, переключаюсь и возвращаюсь к задаче с новыми силами"
          }
        },
        {
          question: "30. Закончите фразу: 'Идеальная профессия для меня - это та, где я...'",
          options: {
            analyst: "'...могу полностью сосредоточиться на решении сложных интеллектуальных задач'",
            innovator: "'...вижу возможность создавать что-то принципиально новое и влиять на культуру'",
            communicator: "'...окружен интересными людьми, с которыми мы делаем важное общее дело'",
            pragmatist: "'...могу видеть конкретные результаты своего труда и их практическое применение'"
          }
        }
      ];

      // РАСШИРЕННЫЕ РЕЗУЛЬТАТЫ ТЕСТА С БОЛЬШИМ ВЫБОРОМ ПРОФЕССИЙ
      const testResults = {
        analyst: {
          title: "Аналитик-стратег",
          description: "Вы сохраняете хладнокровие в сложных ситуациях, любите порядок и тщательно проверенные решения. Ваша сила - в способности видеть системные взаимосвязи и находить оптимальные пути решения.",
          values: "Четкие цели, прозрачные правила игры и глубокая экспертиза.",
          professions: [
            "Data Scientist", "Финансовый аналитик", "Системный архитектор", "Инженер-исследователь", 
            "Продуктовый аналитик", "Бизнес-аналитик", "Маркетинговый аналитик", "Кредитный аналитик",
            "Инвестиционный аналитик", "Системный администратор", "Сетевой инженер", "Архитектор баз данных",
            "Биоинформатик", "Статистик", "Актуарий", "Аналитик кибербезопасности"
          ],
          actions: [
            "Развивайте навыки работы с данными и аналитическими инструментами (SQL, Python, BI-платформы).",
            "Собирайте портфолио кейсов, демонстрирующих вашу способность принимать взвешенные решения.",
            "Выбирайте команды, где ценят аргументы и структурное мышление."
          ],
          recommendedUniversities: ["kaznu", "satbayev", "kbtu"]
        },
        innovator: {
          title: "Инноватор-visioner",
          description: "Вы мыслите смело, легко генерируете идеи и ищете новые способы создавать ценность. Ваше преимущество - в способности видеть возможности там, где другие видят ограничения.",
          values: "Свобода экспериментов, творческая атмосфера и ощущение влияния на будущее.",
          professions: [
            "Продуктовый менеджер", "UX/UI-дизайнер", "Креативный директор", "Стартап-предприниматель", 
            "Стратег по инновациям", "Арт-директор", "Гейм-дизайнер", "Дизайнер интерфейсов",
            "Маркетолог-стратег", "Бренд-менеджер", "Копирайтер", "SMM-специалист",
            "Event-менеджер", "PR-менеджер", "Дизайнер одежды", "Архитектор"
          ],
          actions: [
            "Работайте над разнообразными проектами, чтобы пополнять банк идей и кейсов.",
            "Изучайте методы дизайн-мышления, agile-подходы и Customer Development.",
            "Ищите партнеров, готовых поддержать смелые эксперименты и пилоты."
          ],
          recommendedUniversities: ["atu", "abylai", "dku"]
        },
        communicator: {
          title: "Коммуникатор-интегратор",
          description: "Вы тонко чувствуете людей, создаете доверие и умеете превращать разрозненные интересы в общий результат. Ваш дар - в способности находить общий язык с самыми разными людьми.",
          values: "Сильная команда, прозрачная коммуникация и ощущение значимости своей роли.",
          professions: [
            "HR-бизнес-партнер", "Руководитель проектов", "Бизнес-тренер", "PR-специалист", 
            "Консультант по изменениям", "Менеджер по продажам", "Рекрутер", "Коуч",
            "Психолог", "Социальный работник", "Учитель", "Воспитатель",
            "Менеджер по работе с клиентами", "Торговый представитель", "Менеджер по туризму", "Журналист"
          ],
          actions: [
            "Развивайте навыки фасилитации, конфликт-менеджмента и эмоционального интеллекта.",
            "Формируйте личный бренд эксперта по работе с людьми и сложными переговорами.",
            "Выбирайте проекты, где требуется объединять разные команды и стейкхолдеров."
          ],
          recommendedUniversities: ["abai", "abylai", "dku"]
        },
        pragmatist: {
          title: "Прагматик-созидатель",
          description: "Вы ориентированы на ощутимый результат, любите доводить идеи до конкретных решений и продуктов. Ваша сила - в практичности и способности превращать концепции в работающие системы.",
          values: "Практическая польза, автономность и ощущение личного прогресса.",
          professions: [
            "Инженер по продукту", "Технический лидер", "Архитектор", "Операционный директор", 
            "Инженер-дизайнер", "Программист", "Тестировщик", "DevOps-инженер",
            "Системный инженер", "Инженер-строитель", "Инженер-механик", "Инженер-электрик",
            "Технолог", "Логист", "Снабженец", "Производственный менеджер"
          ],
          actions: [
            "Работайте над проектами, где можно увидеть эффект своими глазами (продукты, сервисы, инфраструктура).",
            "Комбинируйте стратегическое планирование с регулярными ретроспективами для личного роста.",
            "Накапливайте доказательства своей надежности: реализованные проекты, отзывы, метрики."
          ],
          recommendedUniversities: ["satbayev", "kbtu", "atu"]
        }
      };

      let currentUniversityContext = null;
      let currentTestMessageElement = null;
      let currentTestState = {
        inProgress: false,
        currentQuestion: 0,
        answers: [],
        userInterests: []
      };

      let currentTestResult = null;

      function findUniversityByName(message) {
        const lower = message.toLowerCase();
        for (const [key, uni] of Object.entries(universities)) {
          if (uni.aliases.some(alias => lower.includes(alias))) {
            return key;
          }
        }
        return null;
      }

      function getUniversityInfo(universityKey, infoType = 'all') {
        const uni = universities[universityKey];
        if (!uni) return null;

        switch (infoType) {
          case 'military':
            return `🎖️ ${uni.name}\n\nВоенная кафедра: ${uni.military}`;
          case 'scores':
            return `📊 ${uni.name}\n\nПороговые баллы ЕНТ: ${uni.scores}`;
          case 'budget':
            return `💰 ${uni.name}\n\nБюджетные места: ${uni.budget}`;
          case 'directions':
            return `🎯 ${uni.name}\n\nОсновные направления: ${uni.directions}`;
          case 'all':
            return `🏫 ${uni.name}\n\n🎖️ Военная кафедра: ${uni.military}\n📊 Баллы ЕНТ: ${uni.scores}\n💰 Бюджет: ${uni.budget}\n🎯 Направления: ${uni.directions}`;
          default:
            return `🏫 ${uni.name}\n\n${uni.directions}`;
        }
      }

      function showUniversityButtons(messageType) {
        const buttonsMessage = document.createElement('div');
        buttonsMessage.className = 'message bot-message animate-fade-in';
        
        let html = `<div class="test-question">
          <strong>Выберите университет для получения информации:</strong><br><br>
          <div style="display: flex; flex-wrap: wrap; gap: 5px;">`;
        
        Object.entries(universities).forEach(([key, uni]) => {
          const shortName = uni.name.split('(')[0].trim();
          html += `<button class="university-button" onclick="handleUniversitySelect('${key}', '${messageType}')">${shortName}</button>`;
        });
        
        html += `</div></div>`;
        buttonsMessage.innerHTML = html;
        chatContainer.appendChild(buttonsMessage);
        chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
      }

      function handleUniversitySelect(universityKey, infoType) {
        const info = getUniversityInfo(universityKey, infoType);
        if (info) {
          const infoMessage = document.createElement('div');
          infoMessage.className = 'message bot-message animate-fade-in';
          infoMessage.textContent = info;
          chatContainer.appendChild(infoMessage);
          chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
        }
      }

      function showUniversityRecommendations(testResultType) {
        const profile = testResults[testResultType];
        if (!profile || !profile.recommendedUniversities) return;

        const recommendationsMessage = document.createElement('div');
        recommendationsMessage.className = 'message bot-message animate-fade-in';
        
        let html = `<div class="test-question">
          <strong>🎓 Рекомендованные университеты для вас:</strong><br><br>`;
        
        profile.recommendedUniversities.forEach(uniKey => {
          const uni = universities[uniKey];
          if (uni) {
            html += `
              <div class="university-card">
                <strong>${uni.name}</strong><br>
                ${uni.description}<br>
                <strong>Сильные стороны:</strong> ${uni.strengths.join(", ")}<br><br>
                <a href="${uni.url}" target="_blank" class="university-link">Подробнее об университете →</a>
              </div>
            `;
          }
        });
        
        html += `<br>
          <button class="recommendation-button" onclick="showAllUniversityOptions()">
            Показать все варианты университетов
          </button>
        </div>`;
        
        recommendationsMessage.innerHTML = html;
        chatContainer.appendChild(recommendationsMessage);
        chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
      }

      function showAllUniversityOptions() {
        const allUniversitiesMessage = document.createElement('div');
        allUniversitiesMessage.className = 'message bot-message animate-fade-in';
        
        let html = `<div class="test-question">
          <strong>🏛️ Все университеты в нашем каталоге:</strong><br><br>
          <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1rem;">`;
        
        Object.entries(universities).forEach(([key, uni]) => {
          html += `
            <div class="university-card">
              <strong>${uni.name.split('(')[0].trim()}</strong><br>
              <em>${uni.description}</em><br><br>
              <a href="${uni.url}" target="_blank" class="university-link">Подробнее →</a>
            </div>
          `;
        });
        
        html += `</div><br>
          <p><strong>Если какая-то специальность или вуз вас заинтересовали, напишите мне - расскажу подробнее!</strong></p>
        </div>`;
        
        allUniversitiesMessage.innerHTML = html;
        chatContainer.appendChild(allUniversitiesMessage);
        chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
      }

      function showProfessionDetails(profession) {
        const professionMessage = document.createElement('div');
        professionMessage.className = 'message bot-message animate-fade-in';
        
        // Здесь можно добавить более детальную информацию о профессии
        let html = `<div class="test-question">
          <strong>💼 ${profession}</strong><br><br>`;
        
        // Добавляем общее описание для разных категорий профессий
        if (profession.includes('аналитик') || profession.includes('Analyst')) {
          html += `
            <p>Эта профессия требует аналитического мышления, работы с данными и умения находить закономерности. Аналитики востребованы в IT, финансах, маркетинге и многих других отраслях.</p>
            <p><strong>Ключевые навыки:</strong> работа с данными, статистика, аналитическое мышление, визуализация данных</p>
          `;
        } else if (profession.includes('дизайн') || profession.includes('Design')) {
          html += `
            <p>Творческая профессия, сочетающая художественные навыки с техническими знаниями. Дизайнеры создают визуальные решения для продуктов, интерфейсов, брендов и пространств.</p>
            <p><strong>Ключевые навыки:</strong> креативность, работа с графическими редакторами, понимание UX/UI, коммуникация</p>
          `;
        } else if (profession.includes('менеджер') || profession.includes('Manager')) {
          html += `
            <p>Профессия, ориентированная на управление процессами, людьми или проектами. Менеджеры обеспечивают эффективную работу команд и достижение бизнес-целей.</p>
            <p><strong>Ключевые навыки:</strong> лидерство, коммуникация, планирование, решение проблем</p>
          `;
        } else if (profession.includes('инженер') || profession.includes('Engineer')) {
          html += `
            <p>Техническая профессия, связанная с проектированием, разработкой и оптимизацией систем и процессов. Инженеры работают в различных отраслях промышленности и IT.</p>
            <p><strong>Ключевые навыки:</strong> техническое мышление, математика, проектирование, решение технических задач</p>
          `;
        } else {
          html += `
            <p>Эта профессия требует специальных знаний и навыков, которые можно получить через соответствующее образование и практический опыт.</p>
            <p>Хотите узнать о конкретных вузах, где готовят специалистов этого направления?</p>
          `;
        }
        
        html += `<br>
          <button class="university-button" onclick="showAllUniversityOptions()">
            Посмотреть подходящие вузы
          </button>
        </div>`;
        
        professionMessage.innerHTML = html;
        chatContainer.appendChild(professionMessage);
        chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
      }

      function findAnswer(message) {
        const words = message
          .toLowerCase()
          .split(/[^a-zа-яё0-9ё]+/i)
          .filter(w => w && !stopWords.includes(w));
        let best = { answer: defaultReply, score: 0 };
        
        faq.forEach(item => {
          const score = item.keywords.reduce(
            (sum, kw) => words.includes(kw) ? sum + 1 : sum,
            0
          );
          if (score > best.score) best = { answer: item.answer, score };
        });

        // Проверка на запрос теста
        if (best.answer === 'test' || words.some(w => ['тест', 'профориентация', 'опрос'].includes(w))) {
          startProforientationTest();
          return '';
        }

        // Проверка на вопросы об университетах
        if (best.answer === 'military' || best.answer === 'scores' || best.answer === 'budget' || best.answer === 'directions') {
          const foundUni = findUniversityByName(message);
          if (foundUni) {
            return getUniversityInfo(foundUni, best.answer);
          } else {
            showUniversityButtons(best.answer);
            return '';
          }
        }

        // Общий вопрос об университетах
        if (best.answer === 'university') {
          const foundUni = findUniversityByName(message);
          if (foundUni) {
            return getUniversityInfo(foundUni, 'all');
          } else {
            showUniversityButtons('all');
            return '';
          }
        }

        return best.answer;
      }

      function startProforientationTest() {
        currentTestState = {
          inProgress: true,
          currentQuestion: 0,
          answers: [],
          userInterests: []
        };
        currentTestMessageElement = null;        
        showTestQuestion(0);
      }

      function showTestQuestion(questionIndex) {
        const question = proforientationTest[questionIndex];
        
        let html = `<div class="test-question">
          <strong>Вопрос ${questionIndex + 1}/${proforientationTest.length}</strong><br>
          ${question.question}
          <div style="margin-top: 10px;">`;

        Object.entries(question.options).forEach(([type, optionText]) => {
          html += `<button class="test-option" onclick="handleTestAnswer(${questionIndex}, '${type}')">${optionText}</button>`;
        });
        
        html += `</div></div>`;
        if (currentTestMessageElement) {
          currentTestMessageElement.innerHTML = html;
        } else {
          const testMessage = document.createElement('div');
          testMessage.className = 'message bot-message animate-fade-in';
          testMessage.innerHTML = html;
          chatContainer.appendChild(testMessage);
          currentTestMessageElement = testMessage;
        }

        requestAnimationFrame(() => {
          chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
        });
      }

      function handleTestAnswer(questionIndex, answerType) {
        currentTestState.answers[questionIndex] = answerType;
        currentTestState.currentQuestion++;
        
        if (currentTestState.currentQuestion < proforientationTest.length) {
          showTestQuestion(currentTestState.currentQuestion);
        } else {
          finishTest();
        }
      }

      function finishTest() {
        const resultType = calculateTestResult();
        currentTestResult = resultType;
        const profile = testResults[resultType];
        if (!profile) {
          currentTestState.inProgress = false;
          return;
        }

        // Создаем список профессий с кнопками для подробностей
        const professionsList = profile.professions.map(prof => 
          `<button class="profession-button" onclick="showProfessionDetails('${prof}')">${prof}</button>`
        ).join('');

        const actionsList = profile.actions && profile.actions.length
          ? `<ul style="margin: 0.5rem 0 0 1.25rem; list-style: disc;">
              ${profile.actions.map(action => `<li>${action}</li>`).join('')}
            </ul>`
          : '';
        
        let html = `<div class="test-question">
          <strong>🎉 Результаты вашего теста!</strong><br><br>
          <strong>Ваш ведущий архетип: ${profile.title}</strong><br>
          ${profile.description}<br><br>
          <strong>Что вас заряжает:</strong><br>
          ${profile.values}<br><br>
          <strong>Подходящие профессии (${profile.professions.length} вариантов):</strong><br>
          <div style="display: flex; flex-wrap: wrap; gap: 5px; margin: 10px 0;">
            ${professionsList}
          </div>
          <br>
          <strong>Рекомендации к развитию:</strong>
          ${actionsList}
          <br>
          <button class="recommendation-button" onclick="showUniversityRecommendations('${resultType}')">
            🎓 Показать рекомендованные вузы
          </button>
        </div>`;
        
        if (currentTestMessageElement) {
          currentTestMessageElement.innerHTML = html;
        } else {
          const resultMessage = document.createElement('div');
          resultMessage.className = 'message bot-message animate-fade-in';
          resultMessage.innerHTML = html;
          chatContainer.appendChild(resultMessage);
        }

        currentTestMessageElement = null;
        currentTestState.inProgress = false;
        chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
      }

      function calculateTestResult() {
        const scores = {
          analyst: 0,
          innovator: 0,
          communicator: 0,
          pragmatist: 0
        };

        currentTestState.answers.forEach(answerType => {
          if (answerType && Object.prototype.hasOwnProperty.call(scores, answerType)) {
            scores[answerType]++;
          }
        });
        
        const bestEntry = Object.entries(scores).reduce(
          (best, entry) => (entry[1] > best[1] ? entry : best),
          [null, -Infinity]
        );

        return bestEntry[0] || 'analyst';
      }

      // Делаем функции глобальными для обработки кликов
      window.handleTestAnswer = handleTestAnswer;
      window.handleUniversitySelect = handleUniversitySelect;
      window.showUniversityRecommendations = showUniversityRecommendations;
      window.showAllUniversityOptions = showAllUniversityOptions;
      window.showProfessionDetails = showProfessionDetails;

      let pendingMedia = [];

      function clearMediaPreview() {
        pendingMedia = [];
        mediaPreview.innerHTML = '';
        mediaPreview.classList.add('hidden');
        cancelMediaButton.classList.add('hidden');
      }

      function updateMediaPreview() {
        mediaPreview.innerHTML = '';
        pendingMedia.forEach((media, index) => {
          const div = document.createElement('div');
          div.className = 'media-preview-item';
          div.innerHTML = `
            <img src="${media}" alt="Preview">
            <button data-index="${index}" type="button"><i class="fas fa-times"></i></button>
          `;
          mediaPreview.appendChild(div);
          div.querySelector('button').addEventListener('click', () => {
            pendingMedia.splice(index, 1);
            updateMediaPreview();
          });
        });
        mediaPreview.classList.toggle('hidden', pendingMedia.length === 0);
        cancelMediaButton.classList.toggle('hidden', pendingMedia.length === 0);
      }

      function handleFileInput(e) {
        const files = e.target.files;
        if (files.length) {
          Array.from(files).forEach(file => {
            if (!file.type.startsWith('image/')) {
              alert('Пожалуйста, выберите изображение');
              return;
            }
            const reader = new FileReader();
            reader.onload = (event) => {
              pendingMedia.push(event.target.result);
              updateMediaPreview();
            };
            reader.readAsDataURL(file);
          });
          e.target.value = '';
        }
      }

      function createNewChat() {
        // Очищаем контейнер чата
        chatContainer.innerHTML = '';
        
        // Сбрасываем состояние теста
        currentTestState = {
          inProgress: false,
          currentQuestion: 0,
          answers: [],
          userInterests: []
        };
        currentTestMessageElement = null;        
        currentTestResult = null;
        
        // Сбрасываем контекст университета
        currentUniversityContext = null;
        
        // Показываем приветственное сообщение
        const welcomeMsg = document.createElement('div');
        welcomeMsg.className = 'message bot-message animate-fade-in';
        welcomeMsg.textContent = 'Привет! Я ИИ-консультант NeXus. Помогу с выбором профессии, подбором вуза и профориентацией. Можете пройти быстрый тест или задать вопрос о конкретных университетах Казахстана!';
        chatContainer.appendChild(welcomeMsg);
        
        // Очищаем поле ввода
        chatInput.value = '';
        
        // Очищаем превью медиа
        clearMediaPreview();
        
        // Прокручиваем вниз
        chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
      }

      function handleChatSubmit(e) {
        e.preventDefault();
        e.stopPropagation();

        const message = chatInput.value.trim();
        const hasMedia = pendingMedia.length > 0;

        if (!message && !hasMedia) return;

        // Если идет тест, обрабатываем ответы через кнопки
        if (currentTestState.inProgress) {
          const userMsg = document.createElement('div');
          userMsg.className = 'message user-message animate-fade-in';
          userMsg.textContent = message;
          chatContainer.appendChild(userMsg);
          
          const botMsg = document.createElement('div');
          botMsg.className = 'message bot-message animate-fade-in';
          botMsg.textContent = 'Пожалуйста, выбирайте ответы с помощью кнопок выше для точности тестирования.';
          chatContainer.appendChild(botMsg);
          
          chatInput.value = '';
          chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
          return;
        }

        // Add user message
        if (message) {
          const userMsg = document.createElement('div');
          userMsg.className = 'message user-message animate-fade-in';
          userMsg.textContent = message;
          chatContainer.appendChild(userMsg);
        }

        // Add media if any
        if (hasMedia) {
          pendingMedia.forEach(media => {
            const mediaMsg = document.createElement('div');
            mediaMsg.className = 'message message-image user-message animate-fade-in';
            mediaMsg.innerHTML = `<img src="${media}" alt="Sent image">`;
            chatContainer.appendChild(mediaMsg);
          });
        }

        // Force DOM update and scroll to bottom
        requestAnimationFrame(() => {
          chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
        });

        // Clear input and media
        chatInput.value = '';
        clearMediaPreview();

        // Add bot response after delay
        setTimeout(() => {
          const answer = findAnswer(message);
          if (answer) {
            const botMsg = document.createElement('div');
            botMsg.className = 'message bot-message animate-fade-in';
            botMsg.textContent = answer;
            chatContainer.appendChild(botMsg);
            
            requestAnimationFrame(() => {
              chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
            });
          }
        }, 500);
      }

      // Event listeners
      chatFileInput.addEventListener('change', handleFileInput);
      cancelMediaButton.addEventListener('click', clearMediaPreview);
      chatForm.addEventListener('submit', handleChatSubmit);
      clearChatButton.addEventListener('click', createNewChat);

      chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          handleChatSubmit(e);
        }
      });

      // Создаем новый чат при каждой загрузке страницы
      createNewChat();
    });
  </script>
{% endblock %}